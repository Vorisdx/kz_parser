# Firefox + GeckoDriver + X-зависимости уже внутри образа
FROM selenium/standalone-firefox:4.33.0-20250606

USER root
ENV DEBIAN_FRONTEND=noninteractive

# 1. Python 3.12 и pip ─ без лишних пакетов
RUN apt-get update && \
    apt-get install -y --no-install-recommends python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*

# 2. Poetry глобально (без виртуальных окружений)
RUN pip install --no-cache-dir "poetry==1.8.*"
ENV POETRY_VIRTUALENVS_CREATE=false POETRY_NO_INTERACTION=1

# 3. Слои зависимостей
WORKDIR /app
COPY pyproject.toml poetry.lock ./
RUN poetry install --no-dev --no-ansi

# 4. Прикладной код
COPY app.py parser_refactored.py ./

# 5. Переменные и старт
ENV MOZ_HEADLESS=1 \
    STREAMLIT_SERVER_PORT=8080 \
    STREAMLIT_SERVER_ADDRESS=0.0.0.0

CMD ["streamlit", "run", "app.py", "--server.port", "8080", "--server.address", "0.0.0.0"]